<script setup>
import { computed, onBeforeUnmount, onMounted, ref, watch } from 'vue'
import { routes } from './router'
import { startChristmasEffects, stopChristmasEffects } from './utils/christmasEffects'

const apiBase = import.meta.env.DEV
  ? (import.meta.env.VITE_API_BASE || 'http://127.0.0.1:8001'): 
  : '/api'

const loading = ref(false)
const chatLoading = ref(false)
const status = ref({ type: '', message: '' })
const activeMenu = ref('home')
const themeMode = ref(localStorage.getItem('themeMode') || 'dark')
const christmasActive = ref(false)

const token = ref(localStorage.getItem('token') || '')
const currentUser = ref(JSON.parse(localStorage.getItem('user') || 'null'))

const dashboard = ref({
  redis: { register_count: 0, online_count: 0 },
  date: '',
  ip: '',
  weather: '',
})

const users = ref([])
const models = ref([])
const selectedModel = ref(null)
const categories = ref([])
const pages = ref([])
const selectedCategory = ref(null)
const logs = ref([])
const roleStats = ref({ admin: 0, user: 0 })
const rolePrompts = ref([])
const selectedRoleId = ref(null)
const editingRolePrompt = ref(null)
const chatMessages = ref([])
const chatInput = ref('')
const chatModelId = ref(null)
const contacts = ref([])
const peerMessages = ref([])
const selectedPeerId = ref(null)
const peerInput = ref('')
const peerSending = ref(false)
const peerMessagesLoading = ref(false)
const contactSearch = ref('')

const defaultRolePrompt =
  '你是一位可靠的智能助手，请保持简洁、专业并主动提供有用的下一步建议。'

// 未读数：key=peerId, value=count
const unreadMap = ref({})
// 联系人最近一条消息预览（可选展示）
const lastPreviewMap = ref({})

const modals = ref({
  login: false,
  register: false,
  user: false,
  model: false,
  category: false,
  page: false,
  role: false,
  rolePrompt: false,
  rolePromptEdit: false,
  userEdit: false,
  modelEdit: false,
})

const forms = ref({
  login: { name: '', password: '' },
  register: { name: '', password: '', role: 'user' },
  user: { name: '', password: '', role: 'user' },
  editUser: { id: null, name: '', password: '', role: 'user' },
  model: {
    name: '',
    base_url: '',
    api_key: '',
    model_name: '',
    max_tokens: 4096,
    temperature: 1,
    owner_id: '',
  },
  editModel: {
    id: null,
    name: '',
    base_url: '',
    api_key: '',
    model_name: '',
    max_tokens: 4096,
    temperature: 1,
    owner_id: '',
  },
  category: { name: '', description: '' },
  page: { category_id: '', url: '', account: '', password: '', cookie: '', note: '' },
  balance: { userId: '', amount: 0 },
  role: { user_id: '', role: 'user' },
  rolePrompt: { name: '', prompt: '' },
  editRolePrompt: { id: null, name: '', prompt: '' },
})

const reportTrend = ref([52, 66, 48, 72, 95, 88, 76, 110, 90, 130])
const registerTrend = ref([8, 16, 20, 12, 18, 26, 24])
const trafficSources = ref([
  { country: '中国', city: '北京', users: 320, x: 68, y: 38 },
  { country: '美国', city: '旧金山', users: 190, x: 24, y: 44 },
  { country: '德国', city: '柏林', users: 120, x: 50, y: 36 },
  { country: '新加坡', city: '新加坡', users: 150, x: 71, y: 63 },
  { country: '澳大利亚', city: '悉尼', users: 90, x: 80, y: 78 },
])

const isAuthed = computed(() => Boolean(token.value))
const isAdmin = computed(() => currentUser.value?.role === 'admin')
const currentChatModel = computed(() => models.value.find((m) => m.id === chatModelId.value))

const currentRolePrompt = computed(() => {
  const target = rolePrompts.value.find((item) => item.id === selectedRoleId.value)
  if (target) return target.prompt
  return defaultRolePrompt
})

const isDarkMode = computed(() => themeMode.value === 'dark')

const availableContacts = computed(() => {
  const keyword = contactSearch.value.trim().toLowerCase()
  return contacts.value
    .filter((item) => item.id !== currentUser.value?.id)
    .filter((item) => !keyword || item.name.toLowerCase().includes(keyword))
    .sort((a, b) => {
      // 未读优先，其次在线优先，其次名字
      const au = Number(unreadMap.value?.[a.id] || 0)
      const bu = Number(unreadMap.value?.[b.id] || 0)
      if (au !== bu) return bu - au
      if (a.is_online !== b.is_online) return a.is_online ? -1 : 1
      return a.name.localeCompare(b.name)
    })
})

const selectedPeer = computed(() => contacts.value.find((item) => item.id === selectedPeerId.value) || null)

function setStatus(type, message) {
  status.value = { type, message }
  if (message) {
    setTimeout(() => {
      status.value = { type: '', message: '' }
    }, 3200)
  }
}

function setAuth(newToken, user) {
  token.value = newToken
  currentUser.value = user
  localStorage.setItem('token', newToken)
  localStorage.setItem('user', JSON.stringify(user))
}

function clearAuth() {
  disconnectWs()

  token.value = ''
  currentUser.value = null
  rolePrompts.value = []
  selectedRoleId.value = null
  contacts.value = []
  peerMessages.value = []
  selectedPeerId.value = null
  peerInput.value = ''
  unreadMap.value = {}
  lastPreviewMap.value = {}
  localStorage.removeItem('token')
  localStorage.removeItem('user')
}

function escapeHtml(input) {
  return (input || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
}

function renderMarkdown(content) {
  const escaped = escapeHtml(content)
  const withBlocks = escaped.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
  const withInline = withBlocks
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
  const paragraphs = withInline
    .split(/\n{2,}/)
    .map((part) => part.replace(/\n/g, '<br />'))
    .join('</p><p>')
  return `<p>${paragraphs}</p>`
}

function applyThemeClasses() {
  const root = document.documentElement
  if (!root) return
  root.classList.toggle('dark-mode', themeMode.value === 'dark')
  root.classList.toggle('light-mode', themeMode.value === 'light')
}

function switchTheme(mode) {
  themeMode.value = mode
  localStorage.setItem('themeMode', mode)
}

function toggleChristmas() {
  christmasActive.value = !christmasActive.value
  if (christmasActive.value) startChristmasEffects()
  else stopChristmasEffects()
}

function getRouteFromHash() {
  if (typeof window === 'undefined') return '/'
  const hash = window.location.hash || ''
  const path = hash.replace(/^#/, '').trim()
  return path || '/'
}

function resolveRoute(path) {
  return routes.find((route) => route.path === path) || null
}

function navigateTo(menu, options = {}) {
  const target = routes.find((route) => route.menu === menu)
  if (!target) return
  if (target.requiresAdmin && !isAdmin.value) return
  if (target.requiresAuth && !isAuthed.value) return
  activeMenu.value = target.menu
  if (typeof window === 'undefined') return
  const url = `#${target.path}`
  if (options.replace) window.history.replaceState(null, '', url)
  else window.location.hash = target.path
}

function syncRouteFromLocation() {
  const path = getRouteFromHash()
  const route = resolveRoute(path)
  if (!route) {
    navigateTo('home', { replace: true })
    return
  }
  if (route.requiresAdmin && !isAdmin.value) {
    navigateTo('home', { replace: true })
    return
  }
  if (route.requiresAuth && !isAuthed.value) {
    navigateTo('home', { replace: true })
    return
  }
  activeMenu.value = route.menu
}

async function request(path, options = {}) {
  const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) }
  if (token.value) {
    headers.Authorization = `Bearer ${token.value}`
  }
  const response = await fetch(`${apiBase}${path}`, { ...options, headers })
  const rawText = response.status === 204 ? '' : await response.text()
  let data = null
  if (rawText) {
    try {
      data = JSON.parse(rawText)
    } catch (error) {
      data = { detail: rawText }
    }
  }

  if (response.status === 401) {
    clearAuth()
    models.value = []
    users.value = []
    categories.value = []
    pages.value = []
    logs.value = []
    rolePrompts.value = []
    selectedRoleId.value = null
    chatMessages.value = []
    chatInput.value = ''
    dashboard.value = { redis: { register_count: 0, online_count: 0 }, date: '', ip: '', weather: '' }
    throw new Error('登录已失效，请重新登录')
  }

  if (!response.ok) {
    throw new Error(data?.detail || data?.error || '请求失败')
  }
  return data
}

async function fetchDashboard() {
  const data = await request('/dashboard')
  dashboard.value = data
}

async function fetchUsers() {
  if (!isAdmin.value) {
    users.value = []
    return
  }
  users.value = await request('/users')
}

async function fetchModels() {
  models.value = await request('/models')
  if (selectedModel.value) {
    const refreshed = models.value.find((m) => m.id === selectedModel.value.id)
    selectedModel.value = refreshed || null
  }
  if (!chatModelId.value && models.value.length) {
    chatModelId.value = models.value[0].id
  }
}

async function fetchCategories() {
  categories.value = await request('/web/categories')
  if (selectedCategory.value) {
    const refreshed = categories.value.find((c) => c.id === selectedCategory.value.id)
    selectedCategory.value = refreshed || null
  }
}

async function fetchPages(categoryId = null) {
  const query = categoryId ? `?category_id=${categoryId}` : ''
  pages.value = await request(`/web/pages${query}`)
}

async function fetchRoles() {
  if (!isAdmin.value) {
    roleStats.value = { admin: 0, user: 0 }
    return
  }
  const res = await request('/roles')
  roleStats.value = res.roles
}

async function fetchRolePrompts() {
  const res = await request('/role-prompts')
  rolePrompts.value = res
  if (!selectedRoleId.value && rolePrompts.value.length) {
    selectedRoleId.value = rolePrompts.value[0].id
  }
}

async function fetchLogs() {
  if (!isAdmin.value) {
    logs.value = []
    return
  }
  const res = await request('/logs')
  logs.value = res.lines || []
}

function clearUnread(peerId) {
  if (!peerId) return
  unreadMap.value = { ...unreadMap.value, [peerId]: 0 }
}

function incUnread(peerId) {
  if (!peerId) return
  const current = Number(unreadMap.value?.[peerId] || 0)
  unreadMap.value = { ...unreadMap.value, [peerId]: current + 1 }
}

function setLastPreview(peerId, content) {
  if (!peerId) return
  const trimmed = (content || '').trim()
  if (!trimmed) return
  const preview = trimmed.length > 30 ? `${trimmed.slice(0, 30)}…` : trimmed
  lastPreviewMap.value = { ...lastPreviewMap.value, [peerId]: preview }
}

async function fetchContacts({ keepSelected = true } = {}) {
  if (!isAuthed.value) {
    contacts.value = []
    return
  }
  try {
    contacts.value = await request('/contacts')
    if (!keepSelected) {
      selectedPeerId.value = contacts.value[0]?.id || null
      if (selectedPeerId.value) await fetchPeerMessages(selectedPeerId.value)
      return
    }
    // 保持已选会话
    const hasSelected = contacts.value.some((item) => item.id === selectedPeerId.value)
    if (!hasSelected) {
      selectedPeerId.value = contacts.value[0]?.id || null
    }
    if (selectedPeerId.value) {
      await fetchPeerMessages(selectedPeerId.value)
    }
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function fetchPeerMessages(peerId) {
  if (!peerId) return
  peerMessagesLoading.value = true
  try {
    const res = await request(`/contacts/messages/${peerId}`)
    peerMessages.value = res || []
    // 更新预览
    const last = peerMessages.value[peerMessages.value.length - 1]
    if (last?.content) setLastPreview(peerId, last.content)
    // 打开会话即清未读
    clearUnread(peerId)
  } catch (error) {
    setStatus('error', error.message)
  } finally {
    peerMessagesLoading.value = false
  }
}

async function openPeerChat(contact) {
  selectedPeerId.value = contact.id
  await fetchPeerMessages(contact.id)
}

async function syncAll() {
  loading.value = true
  try {
    await Promise.all([
      fetchDashboard(),
      fetchModels(),
      fetchCategories(),
      fetchPages(selectedCategory.value?.id || null),
      fetchUsers(),
      fetchRoles(),
      fetchRolePrompts(),
      fetchLogs(),
      fetchContacts(),
    ])
    setStatus('success', '数据已同步')
  } catch (error) {
    setStatus('error', error.message)
  } finally {
    loading.value = false
  }
}

async function handleLogin() {
  try {
    const res = await request('/auth/login', {
      method: 'POST',
      body: JSON.stringify(forms.value.login),
    })
    setAuth(res.token, res.user)
    modals.value.login = false
    setStatus('success', '登录成功')
    await syncAll()
    connectWs()
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function handleRegister() {
  try {
    const payload = { ...forms.value.register }
    if (!payload.role) payload.role = 'user'
    const res = await request('/auth/register', {
      method: 'POST',
      body: JSON.stringify(payload),
    })
    setStatus('success', `注册成功：${res.name}`)
    modals.value.register = false
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function handleLogout() {
  try {
    await request('/auth/logout', { method: 'POST' })
  } catch (error) {
    console.warn('登出提示：', error.message)
  }
  clearAuth()
  models.value = []
  users.value = []
  categories.value = []
  pages.value = []
  logs.value = []
  rolePrompts.value = []
  selectedRoleId.value = null
  chatMessages.value = []
  chatInput.value = ''
  contacts.value = []
  peerMessages.value = []
  selectedPeerId.value = null
  peerInput.value = ''
  contactSearch.value = ''
  dashboard.value = { redis: { register_count: 0, online_count: 0 }, date: '', ip: '', weather: '' }
}

async function createUser() {
  try {
    await request('/users', {
      method: 'POST',
      body: JSON.stringify(forms.value.user),
    })
    setStatus('success', '用户创建成功')
    modals.value.user = false
    forms.value.user = { name: '', password: '', role: 'user' }
    await fetchUsers()
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function updateBalance(userId) {
  try {
    await request(`/users/${userId}/balance`, {
      method: 'PUT',
      body: JSON.stringify({ amount: Number(forms.value.balance.amount) }),
    })
    setStatus('success', '余额已更新')
    forms.value.balance = { userId: '', amount: 0 }
    await fetchUsers()
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function createModel() {
  try {
    const payload = { ...forms.value.model, owner_id: forms.value.model.owner_id || null }
    await request('/models', {
      method: 'POST',
      body: JSON.stringify(payload),
    })
    setStatus('success', '大模型配置已创建')
    modals.value.model = false
    forms.value.model = {
      name: '',
      base_url: '',
      api_key: '',
      model_name: '',
      max_tokens: 4096,
      temperature: 1,
      owner_id: '',
    }
    await fetchModels()
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function deleteModel(id) {
  if (!confirm('确认删除该配置吗？')) return
  try {
    await request(`/models/${id}`, { method: 'DELETE' })
    setStatus('success', '配置已删除')
    selectedModel.value = null
    await fetchModels()
  } catch (error) {
    setStatus('error', error.message)
  }
}

function openModelDetail(item) {
  selectedModel.value = item
  forms.value.editModel = {
    id: item.id,
    name: item.name,
    base_url: item.base_url,
    api_key: item.api_key,
    model_name: item.model_name,
    max_tokens: item.max_tokens,
    temperature: item.temperature,
    owner_id: item.owner_id ?? '',
  }
}

async function updateModel() {
  if (!forms.value.editModel.id) return
  const payload = {
    name: forms.value.editModel.name,
    base_url: forms.value.editModel.base_url,
    api_key: forms.value.editModel.api_key,
    model_name: forms.value.editModel.model_name,
    max_tokens: Number(forms.value.editModel.max_tokens),
    temperature: Number(forms.value.editModel.temperature),
    owner_id: forms.value.editModel.owner_id || null,
  }
  try {
    await request(`/models/${forms.value.editModel.id}`, {
      method: 'PUT',
      body: JSON.stringify(payload),
    })
    setStatus('success', '模型已更新')
    modals.value.modelEdit = false
    await fetchModels()
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function createCategory() {
  try {
    await request('/web/categories', {
      method: 'POST',
      body: JSON.stringify(forms.value.category),
    })
    setStatus('success', '分类已创建')
    modals.value.category = false
    forms.value.category = { name: '', description: '' }
    await fetchCategories()
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function deleteCategory(id) {
  if (!confirm('确认删除该分类及其网页吗？')) return
  try {
    await request(`/web/categories/${id}`, { method: 'DELETE' })
    setStatus('success', '分类已删除')
    selectedCategory.value = null
    pages.value = []
    await fetchCategories()
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function createPage() {
  try {
    const payload = { ...forms.value.page, category_id: Number(forms.value.page.category_id) }
    await request('/web/pages', {
      method: 'POST',
      body: JSON.stringify(payload),
    })
    setStatus('success', '网页已保存')
    modals.value.page = false
    forms.value.page = { category_id: '', url: '', account: '', password: '', cookie: '', note: '' }
    await fetchPages(selectedCategory.value?.id || null)
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function deletePage(id) {
  if (!confirm('确认删除该网页记录吗？')) return
  try {
    await request(`/web/pages/${id}`, { method: 'DELETE' })
    setStatus('success', '网页已删除')
    await fetchPages(selectedCategory.value?.id || null)
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function assignRole() {
  try {
    await request('/roles/assign', {
      method: 'POST',
      body: JSON.stringify({
        user_id: Number(forms.value.role.user_id),
        role: forms.value.role.role,
      }),
    })
    setStatus('success', '角色已更新')
    modals.value.role = false
    forms.value.role = { user_id: '', role: 'user' }
    await Promise.all([fetchUsers(), fetchRoles()])
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function createRolePrompt() {
  try {
    await request('/role-prompts', {
      method: 'POST',
      body: JSON.stringify(forms.value.rolePrompt),
    })
    setStatus('success', '提示词已创建')
    forms.value.rolePrompt = { name: '', prompt: '' }
    modals.value.rolePrompt = false
    await fetchRolePrompts()
  } catch (error) {
    setStatus('error', error.message)
  }
}

function openEditRolePrompt(item) {
  editingRolePrompt.value = item
  forms.value.editRolePrompt = { ...item }
  modals.value.rolePromptEdit = true
}

async function updateRolePrompt() {
  if (!forms.value.editRolePrompt.id) return
  try {
    await request(`/role-prompts/${forms.value.editRolePrompt.id}`, {
      method: 'PUT',
      body: JSON.stringify({
        name: forms.value.editRolePrompt.name,
        prompt: forms.value.editRolePrompt.prompt,
      }),
    })
    setStatus('success', '提示词已更新')
    modals.value.rolePromptEdit = false
    editingRolePrompt.value = null
    forms.value.editRolePrompt = { id: null, name: '', prompt: '' }
    await fetchRolePrompts()
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function deleteRolePrompt(id) {
  if (!confirm('确认删除该提示词吗？')) return
  try {
    await request(`/role-prompts/${id}`, { method: 'DELETE' })
    setStatus('success', '提示词已删除')
    if (selectedRoleId.value === id) {
      selectedRoleId.value = rolePrompts.value.find((item) => item.id !== id)?.id || null
    }
    await fetchRolePrompts()
  } catch (error) {
    setStatus('error', error.message)
  }
}

function openEditUser(user) {
  forms.value.editUser = { id: user.id, name: user.name, password: '', role: user.role }
  modals.value.userEdit = true
}

async function updateUser() {
  if (!forms.value.editUser.id) return
  try {
    const payload = { name: forms.value.editUser.name, role: forms.value.editUser.role }
    if (forms.value.editUser.password) {
      payload.password = forms.value.editUser.password
    }
    await request(`/users/${forms.value.editUser.id}`, {
      method: 'PUT',
      body: JSON.stringify(payload),
    })
    setStatus('success', '用户信息已更新')
    modals.value.userEdit = false
    forms.value.editUser = { id: null, name: '', password: '', role: 'user' }
    await fetchUsers()
  } catch (error) {
    setStatus('error', error.message)
  }
}

async function deleteUser(userId) {
  if (!confirm('确认删除该用户吗？')) return
  try {
    await request(`/users/${userId}`, { method: 'DELETE' })
    setStatus('success', '用户已删除')
    await Promise.all([fetchUsers(), fetchRoles()])
  } catch (error) {
    setStatus('error', error.message)
  }
}

// ---------------------------
// Chat stream (原逻辑保留)
// ---------------------------
async function handleStreamResponse(response, assistantIndex) {
  const reader = response.body?.getReader()
  if (!reader) {
    throw new Error('浏览器暂不支持流式读取')
  }
  const decoder = new TextDecoder()
  let buffer = ''
  while (true) {
    const { value, done } = await reader.read()
    buffer += decoder.decode(value || new Uint8Array(), { stream: !done })
    const segments = buffer.split('\n\n')
    buffer = segments.pop() || ''
    for (const segment of segments) {
      const line = segment.trim()
      if (!line.startsWith('data:')) continue
      const dataStr = line.replace(/^data:\s*/, '')
      if (dataStr === '[DONE]') {
        return
      }
      try {
        const parsed = JSON.parse(dataStr)
        const delta =
          parsed?.choices?.[0]?.delta?.content || parsed?.choices?.[0]?.message?.content || ''
        if (delta) {
          chatMessages.value[assistantIndex].content += delta
        }
      } catch (err) {
        console.warn('流式解析失败：', err)
      }
    }
    if (done) break
  }
}

async function sendChat() {
  if (!chatInput.value.trim()) {
    setStatus('error', '请输入提问内容')
    return
  }
  if (!models.value.length) {
    setStatus('error', '请先配置可用模型')
    return
  }
  const question = chatInput.value.trim()
  const payloadMessages = [...chatMessages.value, { role: 'user', content: question }]
  chatLoading.value = true
  chatInput.value = ''
  const userMessage = { role: 'user', content: question }
  chatMessages.value.push(userMessage)
  const assistantIndex = chatMessages.value.push({ role: 'assistant', content: 'AI 正在生成中…' }) - 1
  try {
    const headers = { 'Content-Type': 'application/json' }
    if (token.value) headers.Authorization = `Bearer ${token.value}`
    const response = await fetch(`${apiBase}/chat/completions`, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        model_id: chatModelId.value,
        messages: payloadMessages,
        stream: true,
        role_prompt: currentRolePrompt.value || defaultRolePrompt,
        role_id: selectedRoleId.value,
      }),
    })
    if (!response.ok) {
      const errorText = response.status === 204 ? '请求失败' : await response.text()
      throw new Error(errorText || '请求失败')
    }
    const contentType = response.headers.get('content-type') || ''
    if (contentType.includes('text/event-stream')) {
      chatMessages.value[assistantIndex].content = ''
      await handleStreamResponse(response, assistantIndex)
      if (!chatMessages.value[assistantIndex].content) {
        chatMessages.value[assistantIndex].content = '未获取到回复内容'
      }
    } else {
      const res = await response.json()
      const content = res?.choices?.[0]?.message?.content || '未获取到回复内容'
      chatMessages.value[assistantIndex].content = content
    }
  } catch (error) {
    chatMessages.value[assistantIndex].content = `生成失败：${error.message}`
    chatInput.value = question
    setStatus('error', error.message)
  } finally {
    chatLoading.value = false
  }
}

function deleteChatMessage(index) {
  chatMessages.value.splice(index, 1)
}

function resetChat() {
  chatMessages.value = []
  chatInput.value = ''
}

// ---------------------------
// 站内互聊：发送（去重 + 预览）
// ---------------------------
function stableMsgKey(msg) {
  // 后端有 id 最好，没有则做一个稳定 key
  if (msg?.id != null) return `id:${msg.id}`
  const s = `${msg?.sender_id || ''}|${msg?.receiver_id || ''}|${msg?.created_at || ''}|${msg?.content || ''}`
  return `h:${hashString(s)}`
}

function hashString(s) {
  let h = 0
  for (let i = 0; i < s.length; i++) {
    h = (h << 5) - h + s.charCodeAt(i)
    h |= 0
  }
  return String(h)
}

function upsertPeerMessage(msg) {
  if (!msg) return
  const key = stableMsgKey(msg)
  const exists = peerMessages.value.some((m) => stableMsgKey(m) === key)
  if (exists) return
  peerMessages.value.push(msg)
  peerMessages.value.sort((a, b) => new Date(a.created_at) - new Date(b.created_at))
}

async function sendPeerMessage() {
  if (!selectedPeerId.value) {
    setStatus('error', '请先选择联系人')
    return
  }
  if (!peerInput.value.trim()) {
    setStatus('error', '请输入要发送的内容')
    return
  }
  const content = peerInput.value.trim()
  peerSending.value = true
  try {
    const res = await request('/contacts/messages', {
      method: 'POST',
      body: JSON.stringify({ receiver_id: selectedPeerId.value, content }),
    })
    upsertPeerMessage(res)
    setLastPreview(selectedPeerId.value, content)
    peerInput.value = ''
  } catch (error) {
    setStatus('error', error.message)
  } finally {
    peerSending.value = false
  }
}

// ---------------------------
// WebSocket：实时收消息 + 未读
// ---------------------------
const wsRef = ref(null)
const wsConnected = ref(false)
const wsConnecting = ref(false)
const wsRetry = ref(0)
let wsReconnectTimer = null
let wsHeartbeatTimer = null

function safeJsonParse(s) {
  try {
    return JSON.parse(s)
  } catch {
    return null
  }
}

function buildWsUrl() {
  // 支持 apiBase 有无 path
  // http://x:8001 -> ws://x:8001/ws?token=...
  // https://... -> wss://...
  const base = new URL(apiBase)
  base.protocol = base.protocol === 'https:' ? 'wss:' : 'ws:'
  base.pathname = '/ws'
  base.search = `?token=${encodeURIComponent(token.value || '')}`
  return base.toString()
}

function clearWsTimers() {
  if (wsReconnectTimer) {
    clearTimeout(wsReconnectTimer)
    wsReconnectTimer = null
  }
  if (wsHeartbeatTimer) {
    clearInterval(wsHeartbeatTimer)
    wsHeartbeatTimer = null
  }
}

function disconnectWs() {
  clearWsTimers()
  wsConnected.value = false
  wsConnecting.value = false
  wsRetry.value = 0
  try {
    wsRef.value?.close?.()
  } catch {}
  wsRef.value = null
}

function scheduleReconnect() {
  clearWsTimers()
  if (!token.value) return
  // 指数退避（上限 12s）+ 抖动
  const base = Math.min(800 * Math.pow(2, wsRetry.value), 12000)
  const jitter = Math.floor(Math.random() * 400)
  const delay = base + jitter
  wsReconnectTimer = setTimeout(() => {
    wsRetry.value += 1
    connectWs()
  }, delay)
}

function resolveOtherPeerId(msg) {
  // other = (sender == me ? receiver : sender)
  const me = currentUser.value?.id
  if (!me) return null
  if (Number(msg.sender_id) === Number(me)) return Number(msg.receiver_id)
  return Number(msg.sender_id)
}

function handleIncomingPeerMessage(msg) {
  const otherId = resolveOtherPeerId(msg)
  if (!otherId) return

  setLastPreview(otherId, msg.content)

  // 当前会话
  if (Number(selectedPeerId.value) === Number(otherId)) {
    upsertPeerMessage(msg)
    clearUnread(otherId)
    return
  }

  // 非当前会话 -> 未读 + 轻提示
  incUnread(otherId)
}

function handleWsMessage(evt) {
  const raw = evt?.data
  if (!raw) return

  // 支持后端回 'pong' / 'ping'
  if (raw === 'pong' || raw === 'ping') return

  const payload = typeof raw === 'string' ? safeJsonParse(raw) : raw

  if (!payload) return

  // 兼容两种格式：
  // 1) { type: 'peer_message', data: {...} }
  // 2) 直接就是消息体 {...sender_id, receiver_id, content...}
  if (payload.type === 'peer_message' && payload.data) {
    handleIncomingPeerMessage(payload.data)
    return
  }
  if (payload.sender_id && payload.receiver_id && payload.content) {
    handleIncomingPeerMessage(payload)
    return
  }
}

function connectWs() {
  if (!token.value) return
  if (wsRef.value && (wsRef.value.readyState === WebSocket.OPEN || wsRef.value.readyState === WebSocket.CONNECTING)) {
    return
  }

  wsConnecting.value = true
  wsConnected.value = false

  let wsUrl = ''
  try {
    wsUrl = buildWsUrl()
  } catch (e) {
    wsConnecting.value = false
    setStatus('error', 'WebSocket 地址解析失败，请检查 VITE_API_BASE')
    return
  }

  const ws = new WebSocket(wsUrl)
  wsRef.value = ws

  ws.onopen = async () => {
    wsConnected.value = true
    wsConnecting.value = false
    wsRetry.value = 0

    clearWsTimers()
    // 心跳
    wsHeartbeatTimer = setInterval(() => {
      try {
        if (ws.readyState === WebSocket.OPEN) ws.send('ping')
      } catch {}
    }, 20000)

    // 连接成功后刷新一次在线状态（不强制拉消息）
    fetchContacts({ keepSelected: true })
  }

  ws.onmessage = handleWsMessage

  ws.onclose = () => {
    wsConnected.value = false
    wsConnecting.value = false
    scheduleReconnect()
  }

  ws.onerror = () => {
    wsConnected.value = false
    wsConnecting.value = false
    try { ws.close() } catch {}
  }
}

// ---------------------------
// 生命周期 & watch
// ---------------------------
watch(
  () => themeMode.value,
  () => {
    applyThemeClasses()
  },
  { immediate: true }
)

watch(
  () => selectedPeerId.value,
  (peerId) => {
    if (peerId) {
      fetchPeerMessages(peerId)
      clearUnread(peerId)
    } else {
      peerMessages.value = []
    }
  }
)

watch(
  () => token.value,
  (val) => {
    if (val) connectWs()
    else disconnectWs()
  }
)

onMounted(() => {
  applyThemeClasses()
  syncRouteFromLocation()
  window.addEventListener('hashchange', syncRouteFromLocation)
  if (token.value) {
    syncAll()
    connectWs()
  }
})

onBeforeUnmount(() => {
  stopChristmasEffects()
  window.removeEventListener('hashchange', syncRouteFromLocation)
})

watch([isAuthed, isAdmin], () => {
  syncRouteFromLocation()
})
</script>

<template>
  <div class="app-shell" :class="[themeMode, { 'christmas-on': christmasActive }]"><!--
    圣诞按钮触发飘雪效果，主题类用于切换深浅色。-->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">PM</div>
        <div>
          <div class="brand-name">个人管理系统</div>
          <div class="brand-sub">分工明确 · 一键直达</div>
        </div>
      </div>
      <nav class="menu">
        <button :class="{ active: activeMenu === 'home' }" @click="navigateTo('home')">首页</button>
        <button :class="{ active: activeMenu === 'chat' }" @click="navigateTo('chat')" :disabled="!isAuthed">
          星际聊天
        </button>
        <button
          :class="{ active: activeMenu === 'contacts' }"
          @click="navigateTo('contacts')"
          :disabled="!isAuthed"
        >
          站内互聊
        </button>
        <button :class="{ active: activeMenu === 'models' }" @click="navigateTo('models')" :disabled="!isAuthed">
          大模型管理
        </button>
        <button :class="{ active: activeMenu === 'web' }" @click="navigateTo('web')" :disabled="!isAuthed">
          网页收藏
        </button>
        <button :class="{ active: activeMenu === 'users' }" @click="navigateTo('users')" :disabled="!isAdmin">
          用户与角色
        </button>
        <button :class="{ active: activeMenu === 'logs' }" @click="navigateTo('logs')" :disabled="!isAdmin">
          日志记录
        </button>
      </nav>
      <div class="sidebar-footer">
        <p class="muted">注册数：{{ dashboard.redis.register_count }}</p>
        <p class="muted">在线人数：{{ dashboard.redis.online_count }}</p>
      </div>
    </aside>

    <main class="content">
      <header class="topbar">
        <div>
          <p class="eyebrow">管理控制台</p>
          <h1>数据面板 · 精准分区</h1>
        </div>
        <div class="top-actions">
          <button class="ghost" @click="toggleChristmas">
            {{ christmasActive ? '取消圣诞特效' : '圣诞特效' }}
          </button>
          <button class="ghost" @click="switchTheme('light')" :disabled="themeMode === 'light'">白天模式</button>
          <button class="ghost" @click="switchTheme('dark')" :disabled="themeMode === 'dark'">黑暗模式</button>
          <button class="ghost" @click="syncAll" :disabled="!isAuthed || loading">刷新</button>
          <template v-if="!isAuthed">
            <button @click="modals.login = true">登录</button>
            <button class="outline" @click="modals.register = true">注册</button>
          </template>
          <template v-else>
            <div class="avatar">
              {{ currentUser?.name }} / {{ currentUser?.role }}
              <span class="ws-pill" :class="{ ok: wsConnected, bad: !wsConnected }" title="站内互聊实时连接状态">
                {{ wsConnected ? '实时' : (wsConnecting ? '连接中' : '离线') }}
              </span>
            </div>
            <button class="outline" @click="handleLogout">退出</button>
          </template>
        </div>
      </header>

      <div v-if="status.message" class="alert" :class="status.type">
        <strong>{{ status.type === 'error' ? '提示' : '完成' }}：</strong>
        <span>{{ status.message }}</span>
      </div>

      <div v-if="!isAuthed" class="empty">
        <p class="muted">请先登录或注册后查看仪表盘</p>
      </div>

      <template v-else>
        <section v-if="loading" class="loading-banner">正在加载...</section>

        <!-- 站内互聊 -->
        <section class="panel neon-panel wechat-panel" v-if="activeMenu === 'contacts'">
          <div class="panel-header">
            <div>
              <p class="eyebrow">站内互聊</p>
              <h3>仿微信气泡 · 在线联系人</h3>
            </div>
            <div class="header-actions">
              <div class="meta-chip">
                实时：
                <span :style="{ fontWeight: 600 }">
                  {{ wsConnected ? '已连接' : (wsConnecting ? '连接中' : '未连接') }}
                </span>
              </div>
              <div class="meta-chip">在线 {{ contacts.filter((item) => item.is_online).length }} 人</div>
              <button class="outline" @click="fetchContacts({ keepSelected: true })">刷新联系人</button>
              <button class="outline" @click="connectWs" :disabled="wsConnected || wsConnecting">重连</button>
            </div>
          </div>

          <div class="peer-chat">
            <div class="peer-list">
              <div class="peer-list-header">
                <input
                  v-model="contactSearch"
                  class="inline-input"
                  placeholder="搜索联系人或昵称"
                  aria-label="搜索联系人"
                />
                <p class="muted small">点击左侧联系人即可发起聊天</p>
              </div>

              <div class="peer-items">
                <button
                  v-for="contact in availableContacts"
                  :key="contact.id"
                  :class="['peer-item', { active: contact.id === selectedPeerId } ]"
                  @click="openPeerChat(contact)"
                >
                  <div class="peer-avatar" :data-online="contact.is_online">
                    {{ contact.name.slice(0, 1) }}
                    <!-- 红点/未读数 -->
                    <span
                      v-if="Number(unreadMap?.[contact.id] || 0) > 0"
                      class="unread-badge"
                      :title="`未读 ${unreadMap[contact.id]} 条`"
                    >
                      {{ unreadMap[contact.id] > 99 ? '99+' : unreadMap[contact.id] }}
                    </span>
                  </div>

                  <div class="peer-meta">
                    <div class="peer-title">
                      <span class="contact-name">{{ contact.name }}</span>
                      <span class="tag" :class="{ success: contact.is_online }">
                        {{ contact.is_online ? '在线' : '离线' }}
                      </span>
                    </div>
                    <p class="muted small">
                      角色：{{ contact.role }}
                      <span v-if="lastPreviewMap?.[contact.id]" class="preview"> · {{ lastPreviewMap[contact.id] }}</span>
                    </p>
                  </div>
                </button>

                <div v-if="!availableContacts.length" class="empty muted">
                  暂无匹配的联系人，可刷新或清空搜索。
                </div>
              </div>
            </div>

            <div class="peer-conversation">
              <div class="wechat-topbar">
                <div class="wechat-contact" v-if="selectedPeer">
                  <div class="wechat-avatar assistant">{{ selectedPeer.name.slice(0, 1) }}</div>
                  <div>
                    <p class="contact-name">{{ selectedPeer.name }}</p>
                    <p class="contact-desc">
                      {{ selectedPeer.is_online ? '在线，可立即沟通' : '对方离线，可留言' }}
                    </p>
                  </div>
                </div>
                <div class="wechat-contact" v-else>
                  <div class="wechat-avatar assistant">?</div>
                  <div>
                    <p class="contact-name">选择联系人</p>
                    <p class="contact-desc">点击左侧列表开始聊天</p>
                  </div>
                </div>
                <div class="wechat-meta">
                  <span class="meta-chip">消息 {{ peerMessages.length }} 条</span>
                  <span class="meta-chip" v-if="peerMessagesLoading">加载中...</span>
                </div>
              </div>

              <div class="wechat-body peer-body">
                <div
                  v-for="msg in peerMessages"
                  :key="msg.id ?? (msg.sender_id + '-' + msg.created_at)"
                  class="wechat-row"
                  :class="msg.sender_id === currentUser?.id ? 'right' : 'left'"
                >
                  <div class="wechat-avatar" :class="msg.sender_id === currentUser?.id ? 'user' : 'assistant'">
                    {{
                      msg.sender_id === currentUser?.id
                        ? currentUser?.name?.slice(0, 1) || '我'
                        : msg.sender_name?.slice(0, 1) || 'Ta'
                    }}
                  </div>
                  <div class="wechat-bubble" :class="msg.sender_id === currentUser?.id ? 'user' : 'assistant'">
                    <div class="bubble-meta">
                      <span class="role-tag">{{ msg.sender_id === currentUser?.id ? '我' : msg.sender_name }}</span>
                      <span class="bubble-time">{{ new Date(msg.created_at).toLocaleString() }}</span>
                    </div>
                    <div class="bubble-body">{{ msg.content }}</div>
                  </div>
                </div>

                <div v-if="!peerMessages.length && selectedPeer" class="empty muted">还没有历史记录，开始打个招呼吧。</div>
                <div v-if="!selectedPeer" class="empty muted">选择联系人后即可开始对话。</div>
              </div>

              <div class="wechat-composer peer-composer">
                <textarea
                  v-model="peerInput"
                  rows="4"
                  class="wechat-input"
                  placeholder="请输入聊天内容，Enter 发送，Shift+Enter 换行"
                  :disabled="!selectedPeer"
                  @keyup.enter.exact.prevent="sendPeerMessage"
                ></textarea>
                <div class="composer-actions">
                  <div>
                    <p class="muted small">聊天对象：{{ selectedPeer?.name || '未选择' }}</p>
                    <p class="muted small">
                      在线状态：{{ selectedPeer?.is_online ? '在线' : '离线' }} ·
                      实时：{{ wsConnected ? '已连接' : '未连接' }}
                    </p>
                  </div>
                  <div class="composer-buttons">
                    <button class="ghost" @click="peerInput = ''" :disabled="!selectedPeer">清空</button>
                    <button @click="sendPeerMessage" :disabled="peerSending || !selectedPeer">
                      {{ peerSending ? '发送中...' : '发送' }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Chat（原样保留） -->
        <section class="panel neon-panel wechat-panel" v-if="activeMenu === 'chat'">
          <div class="panel-header">
            <div>
              <p class="eyebrow">微信风格对话</p>
              <h3>对话面板 · 沉浸式气泡</h3>
            </div>
            <div class="header-actions wechat-toolbar">
              <div class="toolbar-field">
                <label>角色预设</label>
                <select v-model="selectedRoleId" class="inline-input">
                  <option v-for="prompt in rolePrompts" :key="prompt.id" :value="prompt.id">
                    {{ prompt.name }}
                  </option>
                  <option v-if="!rolePrompts.length" :value="null">默认提示词</option>
                </select>
              </div>
              <div class="toolbar-field">
                <label>使用模型</label>
                <select v-model="chatModelId" class="inline-input" :disabled="!models.length">
                  <option v-for="model in models" :key="model.id" :value="model.id">{{ model.name }}</option>
                </select>
              </div>
              <div class="toolbar-buttons">
                <button class="outline" @click="resetChat">清空历史</button>
                <button class="outline" v-if="isAdmin" @click="modals.rolePrompt = true">新增提示词</button>
              </div>
            </div>
          </div>

          <div class="wechat-chat">
            <div class="wechat-window">
              <div class="wechat-topbar">
                <div class="wechat-contact">
                  <div class="wechat-avatar">{{ currentChatModel?.name?.slice(0, 1) || '星' }}</div>
                  <div>
                    <p class="contact-name">{{ currentChatModel?.name || '星链助手' }}</p>
                    <p class="contact-desc">
                      {{ rolePrompts.find((item) => item.id === selectedRoleId)?.name || '默认提示词' }} · 双击 Enter 换行
                    </p>
                  </div>
                </div>
                <div class="wechat-meta">
                  <span class="meta-chip">上下文 {{ chatMessages.length }} 条</span>
                  <span class="meta-chip" v-if="chatLoading">正在生成...</span>
                </div>
              </div>

              <div class="wechat-body">
                <div
                  v-for="(msg, index) in chatMessages"
                  :key="index"
                  class="wechat-row"
                  :class="msg.role === 'assistant' ? 'left' : 'right'"
                >
                  <div class="wechat-avatar" :class="msg.role === 'assistant' ? 'assistant' : 'user'">
                    {{ msg.role === 'assistant' ? 'AI' : (currentUser?.name?.slice(0, 1) || '我') }}
                  </div>
                  <div class="wechat-bubble" :class="msg.role === 'assistant' ? 'assistant' : 'user'">
                    <div class="bubble-meta">
                      <span class="role-tag">{{ msg.role === 'assistant' ? '星链助手' : '我' }}</span>
                      <button class="icon ghost" @click="deleteChatMessage(index)" title="删除这条记录">×</button>
                    </div>
                    <div class="bubble-body" v-html="renderMarkdown(msg.content)"></div>
                  </div>
                </div>

                <div v-if="!chatMessages.length" class="empty muted">还没有对话记录，发送后会自动携带上下文。</div>
                <div v-if="chatLoading" class="chat-loading-hint">
                  <span class="spinner"></span>
                  <span>AI 正在生成回答，请稍候...</span>
                </div>
              </div>

              <div class="wechat-composer">
                <textarea
                  v-model="chatInput"
                  rows="5"
                  class="wechat-input"
                  placeholder="仿微信气泡体验：输入问题或需求，Enter 发送，Shift+Enter 换行"
                  @keyup.enter.exact.prevent="sendChat"
                ></textarea>
                <div class="composer-actions">
                  <div>
                    <p class="muted small">Markdown 渲染友好，历史自动拼接。</p>
                    <p class="muted small">
                      当前角色：{{ rolePrompts.find((item) => item.id === selectedRoleId)?.name || '默认提示词' }}
                    </p>
                  </div>
                  <div class="composer-buttons">
                    <button class="ghost" @click="resetChat">重置</button>
                    <button @click="sendChat" :disabled="chatLoading">{{ chatLoading ? '正在生成' : '发送' }}</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="table-wrapper" v-if="rolePrompts.length">
            <div class="table-title">角色提示词库</div>
            <table class="table compact">
              <thead>
                <tr>
                  <th>名称</th>
                  <th>提示词</th>
                  <th v-if="isAdmin">操作</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="item in rolePrompts" :key="item.id">
                  <td>{{ item.name }}</td>
                  <td>{{ item.prompt }}</td>
                  <td v-if="isAdmin" class="row-actions">
                    <button class="ghost" @click="openEditRolePrompt(item)">编辑</button>
                    <button class="ghost danger" @click="deleteRolePrompt(item.id)">删除</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- 首页 -->
        <section class="report-section" v-if="activeMenu === 'home'">
          <div class="report-row stats-row">
            <div class="report-card stat-card">
              <div class="card-title">新增注册人数</div>
              <div class="card-value">{{ dashboard.redis.register_count }}</div>
              <p class="muted">实时同步 Redis 注册计数</p>
              <div class="mini-bars">
                <span
                  v-for="(value, idx) in registerTrend"
                  :key="`reg-${idx}`"
                  class="bar"
                  :style="{ height: `${Math.max(30, value * 3)}%` }"
                ></span>
              </div>
            </div>
            <div class="report-card stat-card">
              <div class="card-title">在线人数</div>
              <div class="card-value">{{ dashboard.redis.online_count }}</div>
              <p class="muted">活跃会话实时态势</p>
              <div class="pill-row">
                <span class="pill success">高并发守护</span>
                <span class="pill outline">低延迟</span>
              </div>
            </div>
            <div class="report-card stat-card">
              <div class="card-title">时间 / 天气</div>
              <div class="card-value">{{ dashboard.date || '-' }}</div>
              <p class="muted">{{ dashboard.weather || '晴朗' }}</p>
              <div class="pill-row">
                <span class="pill">本地时间</span>
                <span class="pill">实时气象</span>
              </div>
            </div>
            <div class="report-card stat-card">
              <div class="card-title">来源 IP</div>
              <div class="card-value">{{ dashboard.ip || '-' }}</div>
              <p class="muted">请求入口定位</p>
              <div class="pill-row">
                <span class="pill outline">安全审计</span>
              </div>
            </div>
          </div>

          <div class="report-row main-row">
            <div class="report-card radar-card">
              <div class="card-head">
                <div>
                  <p class="eyebrow">运行态势</p>
                  <h3>实时容量镜像</h3>
                </div>
                <span class="meta-chip">圣诞黑白一键触发</span>
              </div>
              <div class="radar-wrap">
                <div class="radar-core">
                  <div class="radar-ring"></div>
                  <div class="radar-ring small"></div>
                  <div class="radar-dot"></div>
                  <div class="radar-value">{{ dashboard.redis.online_count }}</div>
                  <p class="radar-desc">在线用户</p>
                </div>
                <div class="radar-meta">
                  <p>注册：{{ dashboard.redis.register_count }}</p>
                  <p>天气：{{ dashboard.weather || '晴朗' }}</p>
                  <p>IP：{{ dashboard.ip || '-' }}</p>
                </div>
              </div>
            </div>

            <div class="report-card trend-card">
              <div class="card-head">
                <div>
                  <p class="eyebrow">业务增长</p>
                  <h3>请求与在线走势</h3>
                </div>
                <span class="meta-chip">近 10 组</span>
              </div>
              <div class="line-chart">
                <div
                  v-for="(value, idx) in reportTrend"
                  :key="`trend-${idx}`"
                  class="line-bar"
                  :style="{ height: `${Math.min(140, value)}px` }"
                >
                  <span class="dot"></span>
                  <span class="bar-label">{{ value }}</span>
                </div>
              </div>
            </div>

            <div class="report-card circle-card">
              <div class="card-head">
                <div>
                  <p class="eyebrow">资源占比</p>
                  <h3>模型与角色</h3>
                </div>
                <span class="meta-chip">健康</span>
              </div>
              <div class="circle-wrap">
                <div class="progress-circle">{{ models.length }}</div>
                <p class="muted">已配置模型</p>
                <div class="progress-circle alt">{{ rolePrompts.length || 0 }}</div>
                <p class="muted">预设提示词</p>
              </div>
            </div>
          </div>

          <div class="report-row map-row">
            <div class="report-card map-card">
              <div class="card-head">
                <div>
                  <p class="eyebrow">人数来源</p>
                  <h3>全球点亮分布</h3>
                </div>
                <span class="meta-chip">活跃地区 {{ trafficSources.length }}</span>
              </div>
              <div class="map-board">
                <div class="map-silhouette"></div>
                <div class="map-dots">
                  <span
                    v-for="item in trafficSources"
                    :key="item.country"
                    class="map-dot"
                    :style="{ left: `${item.x}%`, top: `${item.y}%` }"
                    :title="`${item.country} · ${item.city}`"
                  ></span>
                </div>
              </div>
              <ul class="source-list">
                <li v-for="item in trafficSources" :key="item.country">
                  <span class="strong">{{ item.country }}</span>
                  <span class="muted">{{ item.city }}</span>
                  <span class="pill success">{{ item.users }} 人</span>
                </li>
              </ul>
            </div>

            <div class="report-card board-card">
              <div class="card-head">
                <div>
                  <p class="eyebrow">运维快照</p>
                  <h3>实时提示面板</h3>
                </div>
                <span class="meta-chip">安全态</span>
              </div>
              <div class="board-grid">
                <div class="board-item">
                  <p class="muted">圣诞黑白</p>
                  <strong>{{ christmasActive ? '已启用' : '未启用' }}</strong>
                  <small>点击顶部按钮即可触发飘雪与黑白</small>
                </div>
                <div class="board-item">
                  <p class="muted">主题</p>
                  <strong>{{ isDarkMode ? '黑暗模式' : '白天模式' }}</strong>
                  <small>双模式随时切换</small>
                </div>
                <div class="board-item">
                  <p class="muted">在线模型</p>
                  <strong>{{ models.length }}</strong>
                  <small>模型配置总数</small>
                </div>
                <div class="board-item">
                  <p class="muted">在线人数</p>
                  <strong>{{ dashboard.redis.online_count }}</strong>
                  <small>实时在线用户</small>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 模型管理（原样保留） -->
        <section class="panel" v-if="activeMenu === 'models'">
          <div class="panel-header">
            <div>
              <p class="eyebrow">大模型</p>
              <h3>模型访问配置</h3>
            </div>
            <div class="header-actions">
              <button class="outline" @click="syncAll" :disabled="loading">同步</button>
              <button @click="modals.model = true" :disabled="!isAdmin">新建配置</button>
            </div>
          </div>
          <div class="table-wrapper two-column">
            <div class="table-panel">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>名称</th>
                    <th>模型</th>
                    <th>最大 Token</th>
                    <th v-if="isAdmin">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="item in models" :key="item.id" @click="openModelDetail(item)" class="clickable">
                    <td>{{ item.id }}</td>
                    <td>{{ item.name }}</td>
                    <td>{{ item.model_name }}</td>
                    <td>{{ item.max_tokens }}</td>
                    <td v-if="isAdmin">
                      <button class="ghost danger" @click.stop="deleteModel(item.id)">删除</button>
                    </td>
                  </tr>
                  <tr v-if="!models.length">
                    <td colspan="5" class="muted">暂无配置</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="detail-panel" v-if="selectedModel">
              <h4>模型详情</h4>
              <p class="muted">点击列表即可查看详情</p>
              <ul class="detail-list">
                <li><span>名称</span><strong>{{ selectedModel.name }}</strong></li>
                <li><span>接口地址</span><strong>{{ selectedModel.base_url }}</strong></li>
                <li><span>模型</span><strong>{{ selectedModel.model_name }}</strong></li>
                <li><span>密钥</span><strong>{{ selectedModel.api_key }}</strong></li>
                <li><span>最大 Token</span><strong>{{ selectedModel.max_tokens }}</strong></li>
                <li><span>温度</span><strong>{{ selectedModel.temperature }}</strong></li>
                <li><span>绑定用户</span><strong>{{ selectedModel.owner_id || '无' }}</strong></li>
              </ul>
              <div class="row-actions" v-if="isAdmin">
                <button class="ghost" @click="modals.modelEdit = true">编辑配置</button>
                <button class="ghost danger" @click="deleteModel(selectedModel.id)">删除</button>
              </div>
            </div>
          </div>
        </section>

        <!-- 网页收藏（原样保留） -->
        <section class="panel" v-if="activeMenu === 'web'">
          <div class="panel-header">
            <div>
              <p class="eyebrow">网页收藏</p>
              <h3>分类与账号信息</h3>
            </div>
            <div class="header-actions">
              <button class="outline" @click="fetchPages(selectedCategory?.id || null)" :disabled="!categories.length">
                刷新网页
              </button>
              <button class="outline" @click="modals.category = true" :disabled="!isAdmin">新建分类</button>
              <button @click="modals.page = true" :disabled="!isAdmin || !categories.length">新增网页</button>
            </div>
          </div>
          <div class="table-wrapper two-column">
            <div class="table-panel">
              <table class="table">
                <thead>
                  <tr>
                    <th>分类</th>
                    <th>描述</th>
                    <th v-if="isAdmin">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-for="item in categories"
                    :key="item.id"
                    @click="selectedCategory = item; fetchPages(item.id)"
                    class="clickable"
                  >
                    <td>{{ item.name }}</td>
                    <td>{{ item.description || '无' }}</td>
                    <td v-if="isAdmin"><button class="ghost danger" @click.stop="deleteCategory(item.id)">删除</button></td>
                  </tr>
                  <tr v-if="!categories.length">
                    <td colspan="3" class="muted">暂无分类</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="table-panel">
              <table class="table">
                <thead>
                  <tr>
                    <th>网址</th>
                    <th>账号</th>
                    <th>密码</th>
                    <th>备注</th>
                    <th v-if="isAdmin">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="page in pages" :key="page.id">
                    <td>{{ page.url }}</td>
                    <td>{{ page.account || '无' }}</td>
                    <td>{{ page.password || '无' }}</td>
                    <td>{{ page.note || '无' }}</td>
                    <td v-if="isAdmin"><button class="ghost danger" @click="deletePage(page.id)">删除</button></td>
                  </tr>
                  <tr v-if="!pages.length">
                    <td colspan="5" class="muted">请选择分类查看或暂无记录</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- 用户与角色（原样保留） -->
        <section class="panel" v-if="activeMenu === 'users' && isAdmin">
          <div class="panel-header">
            <div>
              <p class="eyebrow">用户</p>
              <h3>用户与余额</h3>
            </div>
            <div class="header-actions">
              <button class="outline" @click="modals.role = true">角色分配</button>
              <button @click="modals.user = true">新建用户</button>
            </div>
          </div>
          <div class="table-wrapper">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>昵称</th>
                  <th>角色</th>
                  <th>余额</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="user in users" :key="user.id">
                  <td>{{ user.id }}</td>
                  <td>{{ user.name }}</td>
                  <td><span class="tag">{{ user.role }}</span></td>
                  <td>¥ {{ user.balance.toFixed(2) }}</td>
                  <td class="row-actions">
                    <input type="number" v-model.number="forms.balance.amount" placeholder="调整金额" class="inline-input" />
                    <button class="ghost" @click="forms.balance.userId = user.id; updateBalance(user.id)">
                      调整余额
                    </button>
                    <button class="ghost" @click="openEditUser(user)">编辑</button>
                    <button class="ghost danger" @click="deleteUser(user.id)">删除</button>
                  </td>
                </tr>
                <tr v-if="!users.length">
                  <td colspan="5" class="muted">暂无用户</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- 日志（原样保留） -->
        <section class="panel" v-if="activeMenu === 'logs' && isAdmin">
          <div class="panel-header">
            <div>
              <p class="eyebrow">日志</p>
              <h3>后端运行记录</h3>
            </div>
            <div class="header-actions">
              <button class="outline" @click="fetchLogs">刷新日志</button>
            </div>
          </div>
          <div class="table-wrapper">
            <table class="table">
              <thead>
                <tr>
                  <th>最近日志</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(line, idx) in logs" :key="idx">
                  <td>{{ line }}</td>
                </tr>
                <tr v-if="!logs.length">
                  <td class="muted">暂无日志记录</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </template>

      <!-- 下面这些 modal 你原本就有，我保持原样 -->
      <div v-if="modals.login" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>登录</h3>
            <button class="icon" @click="modals.login = false">×</button>
          </div>
          <label>用户名</label>
          <input v-model="forms.login.name" placeholder="请输入用户名" />
          <label>密码</label>
          <input v-model="forms.login.password" type="password" placeholder="请输入密码" />
          <button @click="handleLogin">确认登录</button>
        </div>
      </div>

      <div v-if="modals.register" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>注册</h3>
            <button class="icon" @click="modals.register = false">×</button>
          </div>
          <label>用户名</label>
          <input v-model="forms.register.name" placeholder="请输入用户名" />
          <label>密码</label>
          <input v-model="forms.register.password" type="password" placeholder="请输入密码" />
          <label>角色（仅首个管理员允许）</label>
          <select v-model="forms.register.role">
            <option value="user">普通用户</option>
            <option value="admin">管理员</option>
          </select>
          <button @click="handleRegister">完成注册</button>
        </div>
      </div>

      <div v-if="modals.user" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>新建用户</h3>
            <button class="icon" @click="modals.user = false">×</button>
          </div>
          <label>用户名</label>
          <input v-model="forms.user.name" placeholder="请输入用户名" />
          <label>密码</label>
          <input v-model="forms.user.password" type="password" placeholder="初始密码" />
          <label>角色</label>
          <select v-model="forms.user.role">
            <option value="user">普通用户</option>
            <option value="admin">管理员</option>
          </select>
          <button @click="createUser">创建</button>
        </div>
      </div>

      <div v-if="modals.userEdit" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>编辑用户</h3>
            <button class="icon" @click="modals.userEdit = false">×</button>
          </div>
          <label>用户名</label>
          <input v-model="forms.editUser.name" placeholder="请输入用户名" />
          <label>新密码（可选）</label>
          <input v-model="forms.editUser.password" type="password" placeholder="不修改可留空" />
          <label>角色</label>
          <select v-model="forms.editUser.role">
            <option value="user">普通用户</option>
            <option value="admin">管理员</option>
          </select>
          <button @click="updateUser">保存</button>
        </div>
      </div>

      <div v-if="modals.model" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>新建模型配置</h3>
            <button class="icon" @click="modals.model = false">×</button>
          </div>
          <label>名称</label>
          <input v-model="forms.model.name" placeholder="如：内部 GPT" />
          <label>接口地址</label>
          <input v-model="forms.model.base_url" placeholder="https://api.example.com" />
          <label>模型名称</label>
          <input v-model="forms.model.model_name" placeholder="gpt-4o" />
          <label>密钥</label>
          <input v-model="forms.model.api_key" placeholder="sk-xxxx" />
          <label>最大 Token</label>
          <input v-model.number="forms.model.max_tokens" type="number" placeholder="4096" />
          <label>温度</label>
          <input v-model.number="forms.model.temperature" type="number" step="0.1" placeholder="1" />
          <label>绑定用户 ID（可选）</label>
          <input v-model="forms.model.owner_id" placeholder="用户 ID" />
          <button @click="createModel">保存</button>
        </div>
      </div>

      <div v-if="modals.modelEdit" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>编辑模型配置</h3>
            <button class="icon" @click="modals.modelEdit = false">×</button>
          </div>
          <label>名称</label>
          <input v-model="forms.editModel.name" placeholder="如：内部 GPT" />
          <label>接口地址</label>
          <input v-model="forms.editModel.base_url" placeholder="https://api.example.com" />
          <label>模型名称</label>
          <input v-model="forms.editModel.model_name" placeholder="gpt-4o" />
          <label>密钥</label>
          <input v-model="forms.editModel.api_key" placeholder="sk-xxxx" />
          <label>最大 Token</label>
          <input v-model.number="forms.editModel.max_tokens" type="number" placeholder="4096" />
          <label>温度</label>
          <input v-model.number="forms.editModel.temperature" type="number" step="0.1" placeholder="1" />
          <label>绑定用户 ID（可选）</label>
          <input v-model="forms.editModel.owner_id" placeholder="用户 ID" />
          <button @click="updateModel">保存</button>
        </div>
      </div>

      <div v-if="modals.category" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>新建分类</h3>
            <button class="icon" @click="modals.category = false">×</button>
          </div>
          <label>分类名称</label>
          <input v-model="forms.category.name" placeholder="如：工作" />
          <label>描述</label>
          <input v-model="forms.category.description" placeholder="可选描述" />
          <button @click="createCategory">保存</button>
        </div>
      </div>

      <div v-if="modals.page" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>新增网页</h3>
            <button class="icon" @click="modals.page = false">×</button>
          </div>
          <label>所属分类</label>
          <select v-model="forms.page.category_id">
            <option value="" disabled>请选择</option>
            <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
          </select>
          <label>网址</label>
          <input v-model="forms.page.url" placeholder="https://..." />
          <label>账号</label>
          <input v-model="forms.page.account" placeholder="账号（可选）" />
          <label>密码</label>
          <input v-model="forms.page.password" placeholder="密码（可选）" />
          <label>Cookie</label>
          <input v-model="forms.page.cookie" placeholder="Cookie（可选）" />
          <label>备注</label>
          <input v-model="forms.page.note" placeholder="备注信息" />
          <button @click="createPage">保存</button>
        </div>
      </div>

      <div v-if="modals.role" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>角色分配</h3>
            <button class="icon" @click="modals.role = false">×</button>
          </div>
          <label>用户 ID</label>
          <input v-model="forms.role.user_id" placeholder="输入用户 ID" />
          <label>角色</label>
          <select v-model="forms.role.role">
            <option value="user">普通用户</option>
            <option value="admin">管理员</option>
          </select>
          <button @click="assignRole">更新角色</button>
          <p class="muted small">当前统计：管理员 {{ roleStats.admin || 0 }} / 普通 {{ roleStats.user || 0 }}</p>
        </div>
      </div>

      <div v-if="modals.rolePrompt" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>新增提示词</h3>
            <button class="icon" @click="modals.rolePrompt = false">×</button>
          </div>
          <label>名称</label>
          <input v-model="forms.rolePrompt.name" placeholder="如：产品语气" />
          <label>提示词</label>
          <textarea v-model="forms.rolePrompt.prompt" rows="4" placeholder="输入系统提示词"></textarea>
          <button @click="createRolePrompt">保存</button>
        </div>
      </div>

      <div v-if="modals.rolePromptEdit" class="modal-mask">
        <div class="modal">
          <div class="modal-header">
            <h3>编辑提示词</h3>
            <button class="icon" @click="modals.rolePromptEdit = false">×</button>
          </div>
          <label>名称</label>
          <input v-model="forms.editRolePrompt.name" />
          <label>提示词</label>
          <textarea v-model="forms.editRolePrompt.prompt" rows="4"></textarea>
          <button @click="updateRolePrompt">更新</button>
        </div>
      </div>
    </main>
  </div>
</template>

<style scoped>
/* 只加和“未读/实时状态”相关的最小样式，不碰你原有大样式体系 */
.unread-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  min-width: 18px;
  height: 18px;
  padding: 0 6px;
  border-radius: 999px;
  background: #ff3b30;
  color: #fff;
  font-size: 12px;
  line-height: 18px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 14px rgba(255, 59, 48, 0.25);
}

.peer-avatar {
  position: relative;
}

.preview {
  opacity: 0.9;
}

.ws-pill {
  margin-left: 8px;
  display: inline-flex;
  align-items: center;
  height: 18px;
  padding: 0 8px;
  border-radius: 999px;
  font-size: 12px;
  line-height: 18px;
  background: rgba(0, 0, 0, 0.08);
}

.ws-pill.ok {
  background: rgba(0, 200, 83, 0.18);
}

.ws-pill.bad {
  background: rgba(255, 59, 48, 0.18);
}
</style>
