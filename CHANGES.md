# 更新说明

## 新增功能

### 1. 用户个人信息修改功能
- **前端**：点击顶部用户名区域（退出登录旁边）会弹出个人信息编辑窗口
- **功能**：
  - 修改用户名
  - 修改密码（可选，不填则不修改）
  - 添加/修改邮箱
  - 添加/修改手机号
- **权限**：用户只能修改自己的信息，管理员可以修改任何用户

### 2. 修复在线和注册用户统计问题

#### 问题描述
- **注册统计**：之前只依赖Redis的计数器，Redis重启后数据丢失
- **在线统计**：Redis中的token集合可能与数据库不同步

#### 解决方案
- **注册统计**：改为从数据库实时查询用户总数，并同步更新Redis缓存
- **在线统计**：
  - 先清理过期token
  - 从数据库获取有效token
  - 验证Redis中的token是否在数据库中存在
  - 自动同步清理Redis中的无效token
  - 返回准确的在线人数

## 技术实现

### 后端修改

1. **backend/app/crud/token.py**
   - `get_register_count()`: 改为从数据库查询真实用户数，并同步Redis
   - `get_online_count()`: 增加数据库验证和Redis同步逻辑

2. **backend/app/api/routes/users.py**
   - 新增 `PUT /users/{user_id}` 端点，允许用户修改自己的信息
   - 添加权限检查：普通用户只能修改自己，管理员可以修改任何人
   - 普通用户不能修改自己的角色

3. **backend/app/api/routes/auth.py**
   - 更新所有返回 `UserPublic` 的地方，包含 `email` 和 `phone` 字段

4. **backend/app/api/routes/admin.py**
   - 更新所有返回 `UserPublic` 的地方，包含 `email` 和 `phone` 字段

### 前端修改

1. **frontend/src/App.vue**
   - 添加 `profileEdit` 模态框
   - 用户名区域添加点击事件，打开个人信息编辑窗口
   - 新增 `updateProfile()` 函数处理个人信息更新
   - 新增 `openProfileEdit()` 函数打开编辑窗口
   - 添加表单字段：`profileEdit: { name, password, email, phone }`

## 使用说明

### 修改个人信息
1. 登录后，点击右上角的用户名区域（显示"用户名 / 角色"的地方）
2. 弹出"修改个人信息"窗口
3. 可以修改：
   - 用户名（必填）
   - 新密码（可选，不填则不修改）
   - 邮箱（可选）
   - 手机号（可选）
4. 点击"保存"按钮提交修改

### 查看统计数据
- 左侧边栏底部显示：
  - 注册数：系统中的总用户数（从数据库实时统计）
  - 在线人数：当前有效登录的用户数（数据库+Redis同步）

## 测试建议

1. **个人信息修改测试**：
   - 登录普通用户，修改自己的信息
   - 尝试修改用户名为已存在的用户名（应该失败）
   - 修改密码后，退出重新登录验证

2. **统计准确性测试**：
   - 重启Redis服务，查看注册数是否正确
   - 多个用户登录/退出，查看在线人数是否准确
   - 清空Redis的`online_tokens`集合，刷新页面查看是否自动修复

## API端点

### 新增/修改的端点

- `PUT /users/{user_id}` - 更新用户信息
  - 权限：用户可以修改自己，管理员可以修改任何人
  - 请求体：`{ name?, password?, email?, phone? }`
  - 响应：`UserPublic` 对象

- `GET /stats/redis` - 获取Redis统计（已存在，逻辑优化）
  - 响应：`{ register_count, online_count }`
